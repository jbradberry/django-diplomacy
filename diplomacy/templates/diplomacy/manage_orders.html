<html>
  <head>
    <link rel="stylesheet" href="/diplomacy/media/css/orders.css"
      type="text/css">
    <script type="text/javascript"
    src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js">
    </script>
    <script type="text/javascript">
      function objlen(obj) {
	var len = 0;
	$.each(obj, function() { len++; });
	return len;
      }

      function in_obj(item, obj) {
	if ( obj instanceof Array ) {
	  return ( $.inArray(parseInt(item), obj) >= 0 );
	}
	return ( typeof obj[item] != 'undefined' );
      }
	
      function filter(widget, data) {
	if ( objlen(data) == 1 && data[0] == "" ) {
	  widget.val("");
	  widget.fadeOut("def");
	}
	else {
	  if ( widget.is(":hidden") ) { widget.fadeIn(); }
	  if ( !in_obj(widget.val(), data) ) { widget.val(data[0]); }

	  widget.find("option").each(function() {
	    if ( in_obj($(this).val(), data) ) { $(this).show(); }
	    else { $(this).hide(); }
	  });
	}
      }

      function readonly() {
	$(this).hide();
	$(this).parent().append( $(this).find(":selected").text() );
      }
	
      $(document).ready(function() {
	$("col").each(function() { $(this).width( $(this).width() ); });

	$.getJSON("filter/", {}, function(data) {
	  var unit_fixed = data.unit_fixed;
	  var tree = data.tree;

	  $("tr.form").each(function() {
	    var form = $(this);
	    var u_type, actor, action;
	
	    if ( unit_fixed ) {
	      u_type = form.find("select[name$=u_type]");
	      u_type.each(readonly);
	      u_type = u_type.val();
	      actor = form.find("select[name$=actor]");
	      actor.each(readonly);
	      actor = actor.val();
	    } else {
	      form.find("select[name$=u_type]").change(function() {
	        u_type = $(this).val();
	        filter(form.find("select[name$=actor]"), tree[u_type]);
	      }).trigger("change");
	    }

	    form.find("select[name$=actor]").change(function() {
	      actor = $(this).val();
	      filter(form.find("select[name$=action]"), tree[u_type][actor]);
	    }).trigger("change");

	    form.find("select[name$=action]").change(function() {
	      action = $(this).val();
	      var current = tree[u_type][actor][action];
	      filter(form.find("select[name$=target]"), current[0]);
	      filter(form.find("select[name$=destination]"), current[1]);
	    }).trigger("change");

	  });
	});
      });
    </script>
  </head>
  <body>
    <form method="POST" action="">
      {{ formset.management_form }}
      {{ formset.non_form_errors.as_ul }}
      <table class="formset">
	{% for form in formset.forms %}
	{% if forloop.first %}
	{% for field in form.visible_fields %}
	<col id="{{ field.name }}">
	{% endfor %}
	<thead>
	  <tr>
	    {% for field in form.visible_fields %}
	    <th>{{ field.label|capfirst }}</th>
	    {% endfor %}
	  </tr>
	</thead>
	{% endif %}
	<tr class="form{% if form.errors %} errorform{% endif %}">
	  {% for field in form.visible_fields %}
	  <td{% if field.errors %} class="errorfield"{% endif %}>
	    {% if forloop.first %}
	    {% for hidden in form.hidden_fields %}
	    {{ hidden }}
	    {% endfor %}
	    {% endif %}
	    {{ field }}
	  </td>
	  {% endfor %}
	</tr>
	{% endfor %}
      </table>
      <input type="submit" value="Submit" />
    </form>
  </body>
</html>
