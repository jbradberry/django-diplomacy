{% extends "diplomacy/game_detail.html" %}

{% block title %}{{ formset.government.power }} | {{ block.super }}{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ MEDIA_URL }}css/orders.css"
      type="text/css">
    <script type="text/javascript"
    src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js">
    </script>
    <script type="text/javascript">
      function objlen(obj) {
	var len = 0;
	$.each(obj, function() { len++; });
	return len;
      }

      function in_obj(item, obj) {
	if ( obj instanceof Array ) {
          if ( item != "" ) { item = parseInt(item); }
	  return ( $.inArray(item, obj) >= 0 );
	}
	return ( obj.hasOwnProperty(item) );
      }
	
      function filter(widget, data) {
	if ( objlen(data) == 1 && in_obj("", data) ) {
	  widget.val("");
	  widget.fadeOut("def");
	}
	else {
	  if ( widget.is(":hidden") ) { widget.fadeIn(); }

	  widget.find("option").each(function() {
	    if ( in_obj($(this).val(), data) ) { $(this).show(); }
	    else { $(this).hide(); }
	  });

          if ( widget.find("option:selected").is(":hidden") ) {
            widget.find("option:visible:first").attr("selected", "selected");
          }
	}
        widget.trigger("change");
      }

      function readonly() {
	$(this).hide();
	$(this).parent().append( $(this).find(":selected").text() );
      }
	
      $(document).ready(function() {
	$("col").each(function() { $(this).width( $(this).width() ); });

	$.getJSON("filter/", {}, function(data) {
	  var unit_fixed = data.unit_fixed;
	  var tree = data.tree;

	  $("tr.form").each(function() {
	    var form = $(this);
	    var actor, action, assist;

            filter(form.find("select[name$=actor]"), tree);
	
	    if ( unit_fixed ) {
	      actor = form.find("select[name$=actor]");
	      actor.each(readonly);
	      actor = actor.val();
	    }

	    form.find("select[name$=actor]").change(function() {
	      actor = $(this).val();
	      filter(form.find("select[name$=action]"), tree[actor]);
	    }).trigger("change");

	    form.find("select[name$=action]").change(function() {
	      action = $(this).val();
	      var current = tree[actor][action];
	      filter(form.find("select[name$=assist]"), current);
	    }).trigger("change");

	    form.find("select[name$=assist]").change(function() {
	      assist = $(this).val();
	      var current = tree[actor][action][assist];
	      filter(form.find("select[name$=target]"), current);
	    }).trigger("change");

	  });
	});
      });
    </script>
{% endblock %}

{% block page_title %}Orders - {{ formset.government.power }}{% endblock %}

{% block breadcrumbs %}
{{ block.super }}
&rsaquo;
{{ formset.government.power }}
{% endblock %}
    
{% block content %}
    <form method="POST" action="">{% csrf_token %}
      {{ formset.management_form }}
      {{ formset.non_form_errors.as_ul }}
      <table class="formset">
	{% for form in formset.forms %}
	{% if forloop.first %}
	{% for field in form.visible_fields %}
	<col id="{{ field.name }}">
	{% endfor %}
	<thead>
	  <tr>
	    {% for field in form.visible_fields %}
	    <th>{{ field.label|capfirst }}</th>
	    {% endfor %}
	  </tr>
	</thead>
	{% endif %}
	<tr class="form{% if form.errors %} errorform{% endif %}">
	  {% for field in form.visible_fields %}
	  <td{% if field.errors %} class="errorfield"{% endif %}>
	    {% if forloop.first %}
	    {% for hidden in form.hidden_fields %}
	    {{ hidden }}
	    {% endfor %}
	    {% endif %}
	    {{ field }}
	  </td>
	  {% endfor %}
	</tr>
	{% endfor %}
      </table>
      <input type="submit" value="Submit" />
    </form>
{% endblock %}
